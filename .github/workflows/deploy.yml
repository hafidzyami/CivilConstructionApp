name: Deploy to VM

on:
  push:
    branches:
      - main
    paths:
      - 'backend/**'
      - 'frontend/**'
      - 'ocr-service/**'
      - 'CAD-parser/**'
      - '.github/workflows/**'
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for changes
        uses: dorny/paths-filter@v3
        id: changes
        with:
          filters: |
            backend:
              - 'backend/**'
            frontend:
              - 'frontend/**'
            ocr:
              - 'ocr-service/**'
            cad:
              - 'CAD-parser/**'

      - name: Deploy to VM via SSH
        uses: appleboy/ssh-action@v1.0.3
        env:
          POSTGRES_USER: ${{ secrets.POSTGRES_USER }}
          POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
          POSTGRES_DB: ${{ secrets.POSTGRES_DB }}
          POSTGRES_PORT: ${{ secrets.POSTGRES_PORT }}
          NEO4J_USER: ${{ secrets.NEO4J_USER }}
          NEO4J_PASSWORD: ${{ secrets.NEO4J_PASSWORD }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          MINIO_ROOT_USER: ${{ secrets.MINIO_ROOT_USER }}
          MINIO_ROOT_PASSWORD: ${{ secrets.MINIO_ROOT_PASSWORD }}
          MINIO_ACCESS_KEY: ${{ secrets.MINIO_ACCESS_KEY }}
          MINIO_SECRET_KEY: ${{ secrets.MINIO_SECRET_KEY }}
          MINIO_PUBLIC_URL: ${{ secrets.MINIO_PUBLIC_URL }}
          RUNPOD_API_KEY: ${{ secrets.RUNPOD_API_KEY }}
          RUNPOD_OCR_ENDPOINT_ID: ${{ secrets.RUNPOD_OCR_ENDPOINT_ID }}
          RUNPOD_VLM_ENDPOINT_ID: ${{ secrets.RUNPOD_VLM_ENDPOINT_ID }}
          RUNPOD_CUBICASA_ENDPOINT_ID: ${{ secrets.RUNPOD_CUBICASA_ENDPOINT_ID }}
          BACKEND_CHANGED: ${{ steps.changes.outputs.backend }}
          FRONTEND_CHANGED: ${{ steps.changes.outputs.frontend }}
          OCR_CHANGED: ${{ steps.changes.outputs.ocr }}
          CAD_CHANGED: ${{ steps.changes.outputs.cad }}
        with:
          host: ${{ secrets.VM_HOST }}
          username: ${{ secrets.VM_USERNAME }}
          key: ${{ secrets.VM_SSH_KEY }}
          port: ${{ secrets.VM_PORT || 22 }}
          timeout: 24h
          command_timeout: 24h
          envs: POSTGRES_USER,POSTGRES_PASSWORD,POSTGRES_DB,POSTGRES_PORT,NEO4J_USER,NEO4J_PASSWORD,GEMINI_API_KEY,MINIO_ROOT_USER,MINIO_ROOT_PASSWORD,MINIO_ACCESS_KEY,MINIO_SECRET_KEY,MINIO_PUBLIC_URL,RUNPOD_API_KEY,RUNPOD_OCR_ENDPOINT_ID,RUNPOD_VLM_ENDPOINT_ID,RUNPOD_CUBICASA_ENDPOINT_ID,BACKEND_CHANGED,FRONTEND_CHANGED,OCR_CHANGED,CAD_CHANGED
          script: |
            set -e

            APP_DIR="/opt/civilconstruction"
            REPO_DIR="$APP_DIR/repo"

            mkdir -p $APP_DIR/neo4j/data $APP_DIR/neo4j/logs $APP_DIR/neo4j/import $APP_DIR/neo4j/plugins
            mkdir -p $APP_DIR/minio/data
            cd $APP_DIR

            echo "ğŸ“¥ Cloning/updating repository..."
            if [ -d "$REPO_DIR" ]; then
              cd $REPO_DIR
              git fetch origin main
              git reset --hard origin/main
            else
              git clone https://github.com/${{ github.repository }}.git $REPO_DIR
              cd $REPO_DIR
            fi

            echo "ğŸ“ Generating .env file..."
            cat > $APP_DIR/.env <<EOF
            POSTGRES_USER=$POSTGRES_USER
            POSTGRES_PASSWORD=$POSTGRES_PASSWORD
            POSTGRES_DB=$POSTGRES_DB
            POSTGRES_PORT=${POSTGRES_PORT:-5432}
            NEO4J_USER=$NEO4J_USER
            NEO4J_PASSWORD=$NEO4J_PASSWORD
            GEMINI_API_KEY=$GEMINI_API_KEY
            MINIO_ROOT_USER=$MINIO_ROOT_USER
            MINIO_ROOT_PASSWORD=$MINIO_ROOT_PASSWORD
            MINIO_ACCESS_KEY=${MINIO_ACCESS_KEY:-$MINIO_ROOT_USER}
            MINIO_SECRET_KEY=${MINIO_SECRET_KEY:-$MINIO_ROOT_PASSWORD}
            MINIO_PUBLIC_URL=$MINIO_PUBLIC_URL
            MINIO_ENDPOINT=minio
            MINIO_PORT=9000
            MINIO_BUCKET_NAME=civil-llm
            MINIO_USE_SSL=false
            BACKEND_PORT=6969
            FRONTEND_PORT=6968
            CAD_PORT=7001
            NODE_ENV=production
            NEXT_PUBLIC_API_URL=/api
            DATABASE_URL=postgresql://$POSTGRES_USER:$POSTGRES_PASSWORD@host.docker.internal:${POSTGRES_PORT:-5432}/$POSTGRES_DB?schema=public
            CAD_SERVICE_URL=http://cad-service:7001
            NEO4J_URI=bolt://neo4j:7687
            RUNPOD_API_KEY=$RUNPOD_API_KEY
            RUNPOD_OCR_ENDPOINT_ID=$RUNPOD_OCR_ENDPOINT_ID
            RUNPOD_VLM_ENDPOINT_ID=$RUNPOD_VLM_ENDPOINT_ID
            RUNPOD_CUBICASA_ENDPOINT_ID=$RUNPOD_CUBICASA_ENDPOINT_ID

            EOF
            chmod 600 $APP_DIR/.env

            echo "ğŸ“ Generating docker-compose.yml..."
            cat > $APP_DIR/docker-compose.yml <<'COMPOSE_EOF'
            services:
              neo4j:
                image: neo4j:5-community
                container_name: civilconstruction-neo4j
                restart: unless-stopped
                env_file: .env
                ports:
                  - "7474:7474"
                  - "7687:7687"
                environment:
                  - NEO4J_AUTH=${NEO4J_USER}/${NEO4J_PASSWORD}
                  - NEO4J_PLUGINS=["apoc"]
                  - NEO4J_server_memory_heap_initial__size=512m
                  - NEO4J_server_memory_heap_max__size=1G
                  - NEO4J_server_memory_pagecache_size=512m
                  - NEO4J_dbms_security_procedures_unrestricted=apoc.*
                  - NEO4J_server_config_strict__validation_enabled=false
                volumes:
                  - ./neo4j/data:/data
                  - ./neo4j/logs:/logs
                  - ./neo4j/import:/import
                  - ./neo4j/plugins:/plugins
                networks:
                  - civilconstruction-network
                healthcheck:
                  test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:7474 || exit 1"]
                  interval: 15s
                  timeout: 5s
                  retries: 10
                  start_period: 300s

              cad-service:
                build:
                  context: ./repo/CAD-parser
                  dockerfile: Dockerfile
                image: civilconstruction-cad:latest
                container_name: civilconstruction-cad
                restart: unless-stopped
                env_file: .env
                ports:
                  - "${CAD_PORT:-7001}:7001"
                environment:
                  - PYTHONUNBUFFERED=1
                networks:
                  - civilconstruction-network
                healthcheck:
                  test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:7001/health')"]
                  interval: 30s
                  timeout: 10s
                  retries: 3
                  start_period: 30s
                deploy:
                  resources:
                    limits:
                      memory: 2G

              backend:
                build:
                  context: ./repo/backend
                  dockerfile: Dockerfile
                image: civilconstruction-backend:latest
                container_name: civilconstruction-backend
                restart: unless-stopped
                env_file: .env
                environment:
                  - PORT=6969
                  - NODE_ENV=production
                  - GEMINI_API_KEY=${GEMINI_API_KEY}
                  - MINIO_ENDPOINT=minio
                  - MINIO_PUBLIC_URL=${MINIO_PUBLIC_URL}
                  - MINIO_ROOT_USER=${MINIO_ROOT_USER}
                  - MINIO_ROOT_PASSWORD=${MINIO_ROOT_PASSWORD}
                  - MINIO_PORT=9000
                  - MINIO_BUCKET_NAME=civil-llm
                  - MINIO_USE_SSL=false
                  - MINIO_ACCESS_KEY=${MINIO_ACCESS_KEY}
                  - MINIO_SECRET_KEY=${MINIO_SECRET_KEY}
                  - RUNPOD_API_KEY=${RUNPOD_API_KEY}
                  - RUNPOD_OCR_ENDPOINT_ID=${RUNPOD_OCR_ENDPOINT_ID}
                  - RUNPOD_VLM_ENDPOINT_ID=${RUNPOD_VLM_ENDPOINT_ID}
                  - RUNPOD_CUBICASA_ENDPOINT_ID=${RUNPOD_CUBICASA_ENDPOINT_ID}
                ports:
                  - "${BACKEND_PORT:-6969}:6969"
                extra_hosts:
                  - "host.docker.internal:host-gateway"
                networks:
                  - civilconstruction-network
                depends_on:
                  cad-service:
                    condition: service_healthy
                  neo4j:
                    condition: service_healthy
                command: sh -c "npx prisma migrate deploy && node dist/index.js"
                healthcheck:
                  test: ["CMD", "node", "-e", "require('http').get('http://localhost:6969/health', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})"]
                  interval: 30s
                  timeout: 3s
                  retries: 3
                  start_period: 10s

              frontend:
                build:
                  context: ./repo/frontend
                  dockerfile: Dockerfile
                  args:
                    NEXT_PUBLIC_API_URL: /api
                image: civilconstruction-frontend:latest
                container_name: civilconstruction-frontend
                restart: unless-stopped
                env_file: .env
                ports:
                  - "${FRONTEND_PORT:-6968}:3000"
                depends_on:
                  backend:
                    condition: service_healthy
                networks:
                  - civilconstruction-network

            networks:
              civilconstruction-network:
                driver: bridge
            COMPOSE_EOF

            cd $APP_DIR

            # Ensure Neo4j is running (never recreate to avoid 5min restart)
            echo "ğŸ”’ Ensuring Neo4j is running (no recreate)..."
            docker compose up -d --no-recreate neo4j

            # Wait for Neo4j to be healthy before starting dependent services
            echo "ğŸ” Waiting for Neo4j to be healthy..."
            NEO4J_HEALTHY=false
            for i in $(seq 1 60); do
              if docker exec civilconstruction-neo4j cypher-shell -u $NEO4J_USER -p $NEO4J_PASSWORD "RETURN 1" > /dev/null 2>&1; then
                echo "âœ… Neo4j is healthy"
                NEO4J_HEALTHY=true
                break
              fi
              echo "â³ Waiting for Neo4j ($i/60)..."
              sleep 10
            done

            if [ "$NEO4J_HEALTHY" = "false" ]; then
              echo "âŒ Neo4j failed to become healthy after 10 minutes"
              docker logs civilconstruction-neo4j --tail 20
              exit 1
            fi

            # Build and deploy only changed services
            SERVICES_TO_RESTART=""
            if [ "$CAD_CHANGED" = "true" ]; then
              echo "ğŸ”¨ Building CAD service..."
              docker compose build cad-service
              SERVICES_TO_RESTART="$SERVICES_TO_RESTART cad-service"
            fi
            if [ "$BACKEND_CHANGED" = "true" ]; then
              echo "ğŸ”¨ Building Backend..."
              docker compose build backend
              SERVICES_TO_RESTART="$SERVICES_TO_RESTART backend"
            fi
            if [ "$FRONTEND_CHANGED" = "true" ]; then
              echo "ğŸ”¨ Building Frontend..."
              docker compose build frontend
              SERVICES_TO_RESTART="$SERVICES_TO_RESTART frontend"
            fi

            echo "ğŸš€ Starting containers..."
            if [ -n "$SERVICES_TO_RESTART" ]; then
              echo "ğŸ”„ Recreating changed services:$SERVICES_TO_RESTART"
              docker compose up -d --no-deps --force-recreate $SERVICES_TO_RESTART
            fi
            # Ensure all services are up (without recreating existing ones)
            docker compose up -d --no-recreate --remove-orphans

            # --- Connect standalone MinIO to network ---
            echo "ğŸ”— Connecting MinIO to civilconstruction network..."
            NETWORK_NAME="civilconstruction_civilconstruction-network"
            if docker network inspect $NETWORK_NAME >/dev/null 2>&1; then
              if docker inspect minio >/dev/null 2>&1; then
                docker network connect $NETWORK_NAME minio 2>/dev/null && echo "âœ… MinIO connected to network" || echo "âš ï¸  MinIO already connected or connection failed"
                echo "ğŸ”„ Restarting backend to reconnect to MinIO..."
                docker restart civilconstruction-backend
              else
                echo "âš ï¸  MinIO container not found"
              fi
            else
              echo "âš ï¸  Network $NETWORK_NAME not found"
            fi

            echo "ğŸ‰ Deployment Success!"
            docker compose ps