name: Deploy to VM

on:
  push:
    branches:
      - main
    paths:
      - 'backend/**'
      - 'frontend/**'
      - '.github/workflows/**'
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for changes
        uses: dorny/paths-filter@v3
        id: changes
        with:
          filters: |
            backend:
              - 'backend/**'
            frontend:
              - 'frontend/**'

      - name: Deploy to VM via SSH
        uses: appleboy/ssh-action@v1.0.3
        env:
          POSTGRES_USER: ${{ secrets.POSTGRES_USER }}
          POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
          POSTGRES_DB: ${{ secrets.POSTGRES_DB }}
          POSTGRES_PORT: ${{ secrets.POSTGRES_PORT }}
          BACKEND_CHANGED: ${{ steps.changes.outputs.backend }}
          FRONTEND_CHANGED: ${{ steps.changes.outputs.frontend }}
        with:
          host: ${{ secrets.VM_HOST }}
          username: ${{ secrets.VM_USERNAME }}
          key: ${{ secrets.VM_SSH_KEY }}
          port: ${{ secrets.VM_PORT || 22 }}
          timeout: 24h
          command_timeout: 24h
          envs: POSTGRES_USER,POSTGRES_PASSWORD,POSTGRES_DB,POSTGRES_PORT,BACKEND_CHANGED,FRONTEND_CHANGED
          script: |
            set -e  # Exit on error

            APP_DIR="/opt/civilconstruction"
            REPO_DIR="$APP_DIR/repo"

            mkdir -p $APP_DIR && cd $APP_DIR

            echo "ğŸ“¥ Cloning/updating repository..."
            if [ -d "$REPO_DIR" ]; then
              cd $REPO_DIR
              git fetch origin main
              git reset --hard origin/main
            else
              git clone https://github.com/${{ github.repository }}.git $REPO_DIR
              cd $REPO_DIR
            fi

            echo "ğŸ“ Generating .env file..."
            cat > $APP_DIR/.env <<EOF
            POSTGRES_USER=$POSTGRES_USER
            POSTGRES_PASSWORD=$POSTGRES_PASSWORD
            POSTGRES_DB=$POSTGRES_DB
            POSTGRES_PORT=${POSTGRES_PORT:-5432}
            BACKEND_PORT=6969
            FRONTEND_PORT=6968
            NODE_ENV=production
            NEXT_PUBLIC_API_URL=/api
            DATABASE_URL=postgresql://$POSTGRES_USER:$POSTGRES_PASSWORD@host.docker.internal:${POSTGRES_PORT:-5432}/$POSTGRES_DB?schema=public
            EOF
            chmod 600 $APP_DIR/.env

            echo "ğŸ“ Generated .env file:"
            cat $APP_DIR/.env | grep -v PASSWORD

            echo "ğŸ“ Generating docker-compose.yml..."
            cat > $APP_DIR/docker-compose.yml <<'COMPOSE_EOF'
            services:
              backend:
                build:
                  context: ./repo/backend
                  dockerfile: Dockerfile
                image: civilconstruction-backend:latest
                container_name: civilconstruction-backend
                restart: unless-stopped
                env_file: .env
                ports:
                  - "${BACKEND_PORT:-6969}:6969"
                extra_hosts:
                  - "host.docker.internal:host-gateway"
                environment:
                  NODE_ENV: production
                  PORT: 6969
                  DATABASE_URL: postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@host.docker.internal:${POSTGRES_PORT:-5432}/${POSTGRES_DB}?schema=public
                networks:
                  - civilconstruction-network
                command: sh -c "npx prisma migrate deploy && node dist/index.js"
                healthcheck:
                  test: ["CMD", "node", "-e", "require('http').get('http://localhost:6969/health', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})"]
                  interval: 30s
                  timeout: 3s
                  retries: 3
                  start_period: 10s

              frontend:
                build:
                  context: ./repo/frontend
                  dockerfile: Dockerfile
                  args:
                    NEXT_PUBLIC_API_URL: /api
                image: civilconstruction-frontend:latest
                container_name: civilconstruction-frontend
                restart: unless-stopped
                env_file: .env
                ports:
                  - "${FRONTEND_PORT:-6968}:3000"
                environment:
                  NODE_ENV: production
                depends_on:
                  backend:
                    condition: service_healthy
                networks:
                  - civilconstruction-network
                healthcheck:
                  test: ["CMD", "node", "-e", "require('http').get('http://localhost:3000', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})"]
                  interval: 30s
                  timeout: 3s
                  retries: 3
                  start_period: 10s

            networks:
              civilconstruction-network:
                driver: bridge
            COMPOSE_EOF

            cd $APP_DIR

            # Build only what changed
            if [ "$BACKEND_CHANGED" = "true" ]; then
              echo "ğŸ”¨ Building backend image (this may take 10-20 minutes for ML dependencies)..."
              docker compose build backend
            else
              echo "â­ï¸ Backend unchanged, skipping build"
            fi

            if [ "$FRONTEND_CHANGED" = "true" ]; then
              echo "ğŸ”¨ Building frontend image..."
              docker compose build frontend
            else
              echo "â­ï¸ Frontend unchanged, skipping build"
            fi

            echo "ğŸš€ Starting containers..."
            docker compose up -d --remove-orphans

            echo "ğŸ§¹ Pruning old images..."
            docker image prune -af --filter "label!=keep"

            echo "â³ Waiting for services to start..."
            sleep 15

            # Check Backend
            echo "ğŸ” Checking backend health..."
            for i in {1..10}; do
              if curl -s http://localhost:6969/health > /dev/null; then
                echo "âœ… Backend OK"
                break
              fi
              echo "â³ Waiting for backend ($i/10)..."
              sleep 5
              if [ $i -eq 10 ]; then
                echo "âŒ Backend failed to start. Logs:"
                docker compose logs --tail=50 backend
                exit 1
              fi
            done

            # Check Frontend
            echo "ğŸ” Checking frontend health..."
            for i in {1..10}; do
              STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:6968 2>/dev/null || echo "000")
              if [[ "$STATUS" =~ ^[23] ]]; then
                echo "âœ… Frontend OK (HTTP $STATUS)"
                break
              fi
              if nc -z localhost 6968 2>/dev/null; then
                echo "âœ… Frontend OK (port 6968 is listening)"
                break
              fi
              echo "â³ Waiting for frontend ($i/10) [HTTP $STATUS]..."
              sleep 5
              if [ $i -eq 10 ]; then
                echo "âŒ Frontend failed to start. Logs:"
                docker compose logs --tail=50 frontend
                exit 1
              fi
            done

            echo "ğŸ‰ Deployment Success!"
            echo ""
            echo "ğŸ“Š Container Status:"
            docker compose ps
            echo ""
            echo "ğŸ’¾ Disk Usage:"
            df -h / | grep -v Filesystem
            docker system df
