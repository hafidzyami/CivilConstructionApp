name: Deploy to VM

on:
  push:
    branches:
      - main
    paths:
      - 'backend/**'
      - 'frontend/**'
      - '.github/workflows/**'
  workflow_dispatch:

env:
  DOCKER_REGISTRY: ghcr.io
  # Kita set default dulu, tapi nanti akan ditimpa oleh step "Lowercase"
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # ------------------------------------------------------------------
  # JOB 1: BUILD & PUSH
  # ------------------------------------------------------------------
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    outputs:
      backend: ${{ steps.changes.outputs.backend }}
      frontend: ${{ steps.changes.outputs.frontend }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # --- PERBAIKAN: LOWERCASE IMAGE NAME ---
      # Bash syntax ${VAR,,} mengubah string menjadi lowercase
      - name: Lowercase Image Name
        run: |
          echo "IMAGE_NAME=${GITHUB_REPOSITORY,,}" >> $GITHUB_ENV

      - name: Check for changes
        uses: dorny/paths-filter@v3
        id: changes
        with:
          filters: |
            backend:
              - 'backend/**'
            frontend:
              - 'frontend/**'

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.DOCKER_REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # --- BACKEND ---
      - name: Extract metadata for Backend
        if: steps.changes.outputs.backend == 'true'
        id: meta-backend
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.DOCKER_REGISTRY }}/${{ env.IMAGE_NAME }}/backend
          tags: type=raw,value=latest

      - name: Build and push Backend image
        if: steps.changes.outputs.backend == 'true'
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          file: ./backend/Dockerfile
          push: true
          tags: ${{ steps.meta-backend.outputs.tags }}
          labels: ${{ steps.meta-backend.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # --- FRONTEND ---
      - name: Extract metadata for Frontend
        if: steps.changes.outputs.frontend == 'true'
        id: meta-frontend
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.DOCKER_REGISTRY }}/${{ env.IMAGE_NAME }}/frontend
          tags: type=raw,value=latest

      - name: Build and push Frontend image
        if: steps.changes.outputs.frontend == 'true'
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          file: ./frontend/Dockerfile
          push: true
          build-args: |
            NEXT_PUBLIC_API_URL=http://${{ secrets.VM_HOST }}:6969/api
          tags: ${{ steps.meta-frontend.outputs.tags }}
          labels: ${{ steps.meta-frontend.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ------------------------------------------------------------------
  # JOB 2: DEPLOY
  # ------------------------------------------------------------------
  deploy:
    runs-on: ubuntu-latest
    needs: build-and-push
    
    steps:
      # --- PERBAIKAN: LOWERCASE IMAGE NAME (LAGI) ---
      # Perlu dilakukan lagi karena ini job baru (environment terpisah)
      - name: Lowercase Image Name
        run: |
          echo "IMAGE_NAME=${GITHUB_REPOSITORY,,}" >> $GITHUB_ENV

      - name: Deploy to VM via SSH
        uses: appleboy/ssh-action@v1.0.3
        env:
          POSTGRES_USER: ${{ secrets.POSTGRES_USER }}
          POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
          POSTGRES_DB: ${{ secrets.POSTGRES_DB }}
          POSTGRES_PORT: ${{ secrets.POSTGRES_PORT }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_ACTOR: ${{ github.actor }}
          DOCKER_REGISTRY: ${{ env.DOCKER_REGISTRY }}
          # Ambil dari env yang sudah di-lowercase di step sebelumnya
          IMAGE_NAME: ${{ env.IMAGE_NAME }}
          VM_HOST: ${{ secrets.VM_HOST }}
        with:
          host: ${{ secrets.VM_HOST }}
          username: ${{ secrets.VM_USERNAME }}
          key: ${{ secrets.VM_SSH_KEY }}
          port: ${{ secrets.VM_PORT || 22 }}
          timeout: 24h
          command_timeout: 24h
          envs: POSTGRES_USER,POSTGRES_PASSWORD,POSTGRES_DB,POSTGRES_PORT,GITHUB_TOKEN,GITHUB_ACTOR,DOCKER_REGISTRY,IMAGE_NAME,VM_HOST
          script: |
            APP_DIR="/opt/civilconstruction"
            mkdir -p $APP_DIR && cd $APP_DIR

            echo "$GITHUB_TOKEN" | docker login $DOCKER_REGISTRY -u $GITHUB_ACTOR --password-stdin

            # Generate .env
            cat > .env <<EOF
            POSTGRES_USER=$POSTGRES_USER
            POSTGRES_PASSWORD=$POSTGRES_PASSWORD
            POSTGRES_DB=$POSTGRES_DB
            POSTGRES_PORT=${POSTGRES_PORT:-5432}
            BACKEND_PORT=6969
            FRONTEND_PORT=6968
            NODE_ENV=production
            NEXT_PUBLIC_API_URL=http://$VM_HOST:6969/api
            DATABASE_URL=postgresql://$POSTGRES_USER:$POSTGRES_PASSWORD@host.docker.internal:${POSTGRES_PORT:-5432}/$POSTGRES_DB?schema=public
            EOF
            chmod 600 .env
            
            echo "üìù Generated .env file:"
            cat .env | grep -v PASSWORD

            # Generate docker-compose.yml
            # Note: Saya hapus "version: '3.8'" karena itu warning obsolete di log kamu
            cat > docker-compose.yml <<'COMPOSE_EOF'
            services:
              backend:
                image: DOCKER_REGISTRY_PLACEHOLDER/IMAGE_NAME_PLACEHOLDER/backend:latest
                container_name: civilconstruction-backend
                restart: unless-stopped
                env_file: .env
                ports:
                  - "${BACKEND_PORT:-6969}:6969"
                extra_hosts:
                  - "host.docker.internal:host-gateway"
                environment:
                  NODE_ENV: production
                  PORT: 6969
                  DATABASE_URL: postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@host.docker.internal:${POSTGRES_PORT:-5432}/${POSTGRES_DB}?schema=public
                networks:
                  - civilconstruction-network
                command: sh -c "npx prisma migrate deploy && node dist/index.js"
                healthcheck:
                  test: ["CMD", "node", "-e", "require('http').get('http://localhost:6969/health', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})"]
                  interval: 30s
                  timeout: 3s
                  retries: 3
                  start_period: 10s

              frontend:
                image: DOCKER_REGISTRY_PLACEHOLDER/IMAGE_NAME_PLACEHOLDER/frontend:latest
                container_name: civilconstruction-frontend
                restart: unless-stopped
                env_file: .env
                ports:
                  - "${FRONTEND_PORT:-6968}:3000"
                environment:
                  NODE_ENV: production
                depends_on:
                  backend:
                    condition: service_healthy
                networks:
                  - civilconstruction-network
                healthcheck:
                  test: ["CMD", "node", "-e", "require('http').get('http://localhost:3000', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})"]
                  interval: 30s
                  timeout: 3s
                  retries: 3
                  start_period: 10s

            networks:
              civilconstruction-network:
                driver: bridge
            COMPOSE_EOF

            sed -i "s|DOCKER_REGISTRY_PLACEHOLDER|$DOCKER_REGISTRY|g" docker-compose.yml
            sed -i "s|IMAGE_NAME_PLACEHOLDER|$IMAGE_NAME|g" docker-compose.yml

            echo "‚¨áÔ∏è Pulling images (this may take 10-20 minutes for ML dependencies)..."
            # Pull with progress and timeout handling
            docker compose pull --quiet || docker compose pull

            echo "üì¶ Verifying images..."
            docker images | grep civilconstruction

            echo "üöÄ Updating containers..."
            docker compose up -d --remove-orphans
            
            echo "üßπ Pruning old images..."
            docker image prune -af

            echo "Waiting for services..."
            sleep 10
            
            # Check Backend
            for i in {1..6}; do
              if curl -s http://localhost:6969/health > /dev/null; then echo "‚úÖ Backend OK"; break; fi
              echo "‚è≥ Waiting Backend ($i/6)"; sleep 5
              if [ $i -eq 6 ]; then echo "‚ùå Backend Logs:"; docker compose logs backend; exit 1; fi
            done

            # Check Frontend
            for i in {1..6}; do
              STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:3000)
              if [ "$STATUS" == "200" ]; then echo "‚úÖ Frontend OK"; break; fi
              echo "‚è≥ Waiting Frontend ($i/6)"; sleep 5
              if [ $i -eq 6 ]; then echo "‚ùå Frontend Logs:"; docker compose logs frontend; exit 1; fi
            done
            
            echo "üéâ Deployment Success!"