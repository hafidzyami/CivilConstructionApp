version: '3.8'
services:
  neo4j:
    container_name: civilconstruction-neo4j
    image: neo4j:5-community
    restart: unless-stopped
    ports:
      - '7474:7474'
      - '7687:7687'
    volumes:
      - ./neo4j/data:/data
      - ./neo4j/logs:/logs
      - ./neo4j/import:/import
      - ./neo4j/plugins:/plugins
    environment:
      - NEO4J_AUTH=${NEO4J_USERNAME}/${NEO4J_PASSWORD}
      - NEO4J_PLUGINS=["apoc"]
      - NEO4J_server_memory_heap_initial__size=512m
      - NEO4J_server_memory_heap_max__size=1G
      - NEO4J_server_memory_pagecache_size=512m
      - NEO4J_dbms_security_procedures_unrestricted=apoc.*
      - NEO4J_server_config_strict__validation_enabled=false
    networks:
      - civilconstruction-network
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:7474 || exit 1"]
      interval: 15s
      timeout: 5s
      retries: 10
      start_period: 300s

  cad-service:
    container_name: civilconstruction-cad
    build:
      context: ./CAD-parser
      dockerfile: Dockerfile
    restart: unless-stopped
    ports:
      - ${CAD_PORT:-7001}:7001
    environment:
      PYTHONUNBUFFERED: 1
    networks:
      - civilconstruction-network
    healthcheck:
      test:
        - CMD
        - python
        - '-c'
        - import urllib.request; urllib.request.urlopen('http://localhost:7001/health')
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    deploy:
      resources:
        limits:
          memory: 2G
        reservations:
          memory: 512M

  cubicasa-service:
    container_name: civilconstruction-cubicasa
    build:
      context: ./CubiCasa5k
      dockerfile: Dockerfile.api
    restart: unless-stopped
    ports:
      - ${CUBICASA_PORT:-7002}:7002
    environment:
      PYTHONUNBUFFERED: 1
      PORT: 7002
      CUBICASA_WEIGHTS: /app/model_best_val_loss_var.pkl
    networks:
      - civilconstruction-network
    healthcheck:
      test:
        - CMD
        - python
        - '-c'
        - import urllib.request; urllib.request.urlopen('http://localhost:7002/health')
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 120s
    deploy:
      resources:
        limits:
          memory: 6G
        reservations:
          memory: 2G

  backend:
    container_name: civilconstruction-backend
    build:
      context: ./backend
      dockerfile: Dockerfile
    restart: unless-stopped
    extra_hosts:
      - host.docker.internal:host-gateway
    depends_on:
      neo4j:
        condition: service_healthy
      cad-service:
        condition: service_healthy
    ports:
      - ${BACKEND_PORT:-6969}:6969
    environment:
      NODE_ENV: ${NODE_ENV:-production}
      PORT: 6969
      DATABASE_URL: postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@host.docker.internal:${POSTGRES_PORT:-5432}/${POSTGRES_DB}?schema=public
      CAD_SERVICE_URL: http://cad-service:7001
      RUNPOD_API_KEY: ${RUNPOD_API_KEY}
      RUNPOD_OCR_ENDPOINT_ID: ${RUNPOD_OCR_ENDPOINT_ID}
      RUNPOD_VLM_ENDPOINT_ID: ${RUNPOD_VLM_ENDPOINT_ID}
      RUNPOD_CUBICASA_ENDPOINT_ID: ${RUNPOD_CUBICASA_ENDPOINT_ID:-}
      CUBICASA_SERVICE_URL: http://cubicasa-service:7002
      NEO4J_URI: bolt://neo4j:7687
      NEO4J_USERNAME: ${NEO4J_USERNAME}
      NEO4J_PASSWORD: ${NEO4J_PASSWORD}
      GEMINI_API_KEY: ${GEMINI_API_KEY}
      MINIO_ENDPOINT: ${MINIO_ENDPOINT:-host.docker.internal}
      MINIO_PUBLIC_URL: ${MINIO_PUBLIC_URL}
      MINIO_ROOT_USER: ${MINIO_ROOT_USER}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD}
      MINIO_PORT: ${MINIO_PORT:-9000}
      MINIO_BUCKET_NAME: ${MINIO_BUCKET_NAME:-civil-llm}
      MINIO_USE_SSL: ${MINIO_USE_SSL:-false}
      MINIO_ACCESS_KEY: ${MINIO_ACCESS_KEY}
      MINIO_SECRET_KEY: ${MINIO_SECRET_KEY}
    networks:
      - civilconstruction-network
    healthcheck:
      test:
        - CMD
        - node
        - '-e'
        - 'require(''http'').get(''http://localhost:6969/health'', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})'
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 10s
    command: sh -c "npx prisma migrate deploy && node dist/index.js"

  frontend:
    container_name: civilconstruction-frontend
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        NEXT_PUBLIC_API_URL: ${NEXT_PUBLIC_API_URL:-http://localhost:3001/api}
    restart: unless-stopped
    depends_on:
      backend:
        condition: service_healthy
    ports:
      - ${FRONTEND_PORT:-6968}:3000
    environment:
      NODE_ENV: ${NODE_ENV:-production}
    networks:
      - civilconstruction-network
    healthcheck:
      test:
        - CMD
        - node
        - '-e'
        - 'require(''http'').get(''http://localhost:3000'', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})'
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 10s

networks:
  civilconstruction-network:
    driver: bridge
