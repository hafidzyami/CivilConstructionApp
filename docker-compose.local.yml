version: '3.8'
services:
  neo4j:
    container_name: civilconstruction-neo4j
    image: neo4j:5-community
    restart: unless-stopped
    ports:
      - '7474:7474'
      - '7687:7687'
    volumes:
      - ./neo4j/data:/data
      - ./neo4j/logs:/logs
      - ./neo4j/import:/import
      - ./neo4j/plugins:/plugins
    environment:
      - NEO4J_AUTH=${NEO4J_USERNAME}/${NEO4J_PASSWORD}
      - NEO4J_PLUGINS=["apoc"]
      - NEO4J_server_memory_heap_initial__size=512m
      - NEO4J_server_memory_heap_max__size=1G
      - NEO4J_server_memory_pagecache_size=512m
      - NEO4J_dbms_security_procedures_unrestricted=apoc.*
      - NEO4J_server_config_strict__validation_enabled=false
    networks:
      - civilconstruction-network
    healthcheck:
      test:
        - CMD
        - cypher-shell
        - '-u'
        - ${NEO4J_USERNAME}
        - '-p'
        - ${NEO4J_PASSWORD}
        - RETURN 1
      interval: 10s
      timeout: 10s
      retries: 5
      start_period: 30s

  ocr-service:
    container_name: civilconstruction-ocr
    build:
      context: ./ocr-service
      dockerfile: Dockerfile
    restart: unless-stopped
    ports:
      - ${OCR_PORT:-7000}:7000
    environment:
      PYTHONUNBUFFERED: 1
    networks:
      - civilconstruction-network
    healthcheck:
      test:
        - CMD
        - python
        - '-c'
        - import urllib.request; urllib.request.urlopen('http://localhost:7000/health')
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    deploy:
      resources:
        limits:
          memory: 8G
        reservations:
          memory: 4G

  cad-service:
    container_name: civilconstruction-cad
    build:
      context: ./CAD-parser
      dockerfile: Dockerfile
    restart: unless-stopped
    ports:
      - ${CAD_PORT:-7001}:7001
    environment:
      PYTHONUNBUFFERED: 1
    networks:
      - civilconstruction-network
    healthcheck:
      test:
        - CMD
        - python
        - '-c'
        - import urllib.request; urllib.request.urlopen('http://localhost:7001/health')
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    deploy:
      resources:
        limits:
          memory: 2G
        reservations:
          memory: 512M

  backend:
    container_name: civilconstruction-backend
    build:
      context: ./backend
      dockerfile: Dockerfile
    restart: unless-stopped
    depends_on:
      neo4j:
        condition: service_healthy
      ocr-service:
        condition: service_healthy
      cad-service:
        condition: service_healthy
    ports:
      - ${BACKEND_PORT:-6969}:6969
    environment:
      NODE_ENV: ${NODE_ENV:-production}
      PORT: 6969
      DATABASE_URL: postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@72.60.78.42:${POSTGRES_PORT:-5432}/${POSTGRES_DB}?schema=public
      OCR_SERVICE_URL: http://ocr-service:7000
      CAD_SERVICE_URL: http://cad-service:7001
      NEO4J_URI: bolt://neo4j:7687
      NEO4J_USERNAME: ${NEO4J_USERNAME}
      NEO4J_PASSWORD: ${NEO4J_PASSWORD}
      GEMINI_API_KEY: ${GEMINI_API_KEY}
    networks:
      - civilconstruction-network
    healthcheck:
      test:
        - CMD
        - node
        - '-e'
        - 'require(''http'').get(''http://localhost:6969/health'', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})'
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 10s
    command: sh -c "npx prisma migrate deploy && node dist/index.js"
    extra_hosts:
      - host.docker.internal:host-gateway

  frontend:
    container_name: civilconstruction-frontend
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        NEXT_PUBLIC_API_URL: ${NEXT_PUBLIC_API_URL:-http://localhost:3001/api}
    restart: unless-stopped
    depends_on:
      backend:
        condition: service_healthy
    ports:
      - ${FRONTEND_PORT:-6968}:3000
    environment:
      NODE_ENV: ${NODE_ENV:-production}
    networks:
      - civilconstruction-network
    healthcheck:
      test:
        - CMD
        - node
        - '-e'
        - 'require(''http'').get(''http://localhost:3000'', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})'
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 10s

networks:
  civilconstruction-network:
    driver: bridge
